<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Zooplankton: catch prey like a copepod!</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #info {
      text-align: center;
      margin: 10px;
      max-width: 600px;
    }

    canvas {
      display: block;
      background: #e0f7fa;
      border: 2px solid #000;
      max-width: 100%;
      height: auto;
    }

    button {
      margin: 5px;
      padding: 8px 14px;
    }

    #message {
      font-weight: bold;
      color: green;
      margin-top: 10px;
      font-size: 18px;
    }

    #explanation {
      max-width: 600px;
      margin: 10px;
      text-align: left;
      font-size: 14px;
      font-weight: bold;
    }

    #gameplay-instructions {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }

    /* Game + controls container – centred */
    #game-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 10px;
    }

    /* Arrow buttons below the game */
    #touch-controls {
      margin-top: 8px;
      text-align: center;
    }

    #touch-controls button {
      width: 60px;
      height: 60px;
      font-size: 24px;
      margin: 4px;
    }
  </style>
</head>
<body>
  <div id="info">
    <h2>Zooplankton: catch prey like a copepod!</h2>
    <p id="gameplay-instructions">Use the arrow keys or the on-screen arrows to catch as many prey as you can!</p>
    <p>Move the copepod, catch dinoflagellates, avoid sand!</p>
    <button onclick="startLevel(1)">Start Level 1: Normal</button>
    <button onclick="startLevel(2)">Start Level 2: Turbulence</button>
    <button onclick="startLevel(3)">Start Level 3: Turbidity</button>
    <button onclick="startLevel(4)">Start Level 4: Turbulence + Turbidity</button>
    <p id="score">Score: 0</p>
    <p id="timer">Timer: --</p>
    <p id="message"></p>
  </div>

  <!-- GAME + ARROW BUTTONS, CENTRED -->
  <div id="game-container">
    <div id="canvas-wrapper"></div>

    <div id="touch-controls">
      <button id="btn-up">▲</button><br>
      <button id="btn-left">◀</button>
      <button id="btn-down">▼</button>
      <button id="btn-right">▶</button>
    </div>
  </div>

  <div id="explanation"></div>

  <!-- p5.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  <script>
    let copepod;
    let prey = [];
    let sandParticles = [];
    let fecalPellets = [];
    let score = 0;
    let level = 1;
    let turbidity = false;
    let capturedThisCycle = [];
    let feedingCooldown = 0;

    // Timer
    let timerActive = false;
    let timerStart = 0;
    let movementStarted = false;
    let preyCaptures = 0;

    function setup() {
      const w = Math.min(500, windowWidth * 0.95);
      const h = 300;
      const cnv = createCanvas(w, h);
      cnv.parent("canvas-wrapper");

      copepod = new Copepod();
      resetEntities();
      setupTouchControls();
    }

    function windowResized() {
      const w = Math.min(500, windowWidth * 0.95);
      const h = 300;
      resizeCanvas(w, h);
    }

    function draw() {
      background(224, 247, 250);
      if (feedingCooldown > 0) feedingCooldown--;

      // Timer display
      if (timerActive) {
        const elapsed = millis() - timerStart;
        document.getElementById("timer").innerText =
          "Timer: " + (elapsed / 1000).toFixed(1) + " s";
      }

      // Fecal pellets
      for (let pellet of fecalPellets) pellet.show();

      // Sand (turbidity levels)
      if ((level === 3 || level === 4) && turbidity) {
        for (let s of sandParticles) {
          s.move();
          s.show();
          if (copepod.catches(s)) {
            score -= 0.1;
            updateScore();
            s.reset();
            capturedThisCycle.push("sand");
            feedingCooldown = 40;
            schedulePellet();
          }
        }
      }

      copepod.move();
      copepod.show();

      // Prey
      for (let p of prey) {
        p.move();
        p.show();
        if (copepod.catches(p) && feedingCooldown <= 0) {
          score++;
          updateScore();
          p.reset();
          capturedThisCycle.push("prey");
          feedingCooldown = 20;
          schedulePellet();

          preyCaptures++;
          if (preyCaptures === 10 && timerActive) {
            timerActive = false;
          }
        }
      }

      // Remove old pellets
      fecalPellets = fecalPellets.filter(p => millis() - p.timestamp < 5000);
    }

    function updateScore() {
      document.getElementById("score").innerText = "Score: " + score.toFixed(3);
      if (score >= 10) {
        let msg = document.getElementById("message");
        msg.innerText = "Congratulations on being an efficient copepod! You contribute to a healthy North Sea ecosystem that is well-balanced!";
        msg.style.display = "block";
        setTimeout(() => { msg.innerText = ""; }, 10000);
      }
    }

    function schedulePellet() {
      setTimeout(() => {
        let x = copepod.x;
        let y = copepod.y;
        let type = "mixed";
        if (capturedThisCycle.length === 1) type = capturedThisCycle[0];
        fecalPellets.push(new Pellet(x, y, type));
        capturedThisCycle = [];
      }, 3000);
    }

    function startTimerIfNeeded() {
      if (!movementStarted) {
        movementStarted = true;
        timerActive = true;
        timerStart = millis();
      }
    }

    function keyPressed() {
      if (keyCode === LEFT_ARROW || keyCode === RIGHT_ARROW ||
          keyCode === UP_ARROW || keyCode === DOWN_ARROW) {
        startTimerIfNeeded();
      }

      if (keyCode === LEFT_ARROW)  copepod.setDir(-1, 0);
      if (keyCode === RIGHT_ARROW) copepod.setDir( 1, 0);
      if (keyCode === UP_ARROW)    copepod.setDir(0, -1);
      if (keyCode === DOWN_ARROW)  copepod.setDir(0,  1);
    }

    function keyReleased() {
      copepod.setDir(0, 0);
    }

    function startLevel(lv) {
      level = lv;
      score = 0;
      updateScore();
      turbidity = (lv === 3 || lv === 4);
      resetEntities();

      timerActive = false;
      movementStarted = false;
      preyCaptures = 0;
      document.getElementById("timer").innerText = "Timer: --";
      document.getElementById("message").innerText = "";

      const explanation = document.getElementById("explanation");
      if (lv === 1) {
        explanation.innerText = "As you can see, it is quite easy to catch prey in these conditions! The more we eat, the more we can reproduce, grow and produce fecal pellets! These fecal pellets often sink to the bottom of the seafloor and provide food for benthic organisms, or fecal pellets end up buried in the seafloor, storing carbon and helping in reducing carbon dioxide levels in the atmosphere.";
      } else if (lv === 2) {
        explanation.innerText = "With turbulence increasing, the chances of encountering prey increase, so you can easily eat more! However, when turbulence is too high, a copepod's feeding current is eroded and/or their ability to detect prey is significantly decreased.";
      } else if (lv === 3) {
        explanation.innerText = "When turbidity is present, copepods accidentally ingest sand particles, which take up room in their guts, decreasing their ability to feed on prey and reducing the carbon content of fecal pellets.";
      } else if (lv === 4) {
        explanation.innerText = "With high turbulence and turbidity, a copepod struggles to select prey and ingests more and more sand particles, taking up valuable space in the gut and further reducing fecal pellet carbon content.";
      }
    }

    function resetEntities() {
      prey = [];
      sandParticles = [];
      fecalPellets = [];
      capturedThisCycle = [];
      feedingCooldown = 0;

      let preyCount = 8;
      let preySpeed = (level === 2 || level === 4) ? 7.5 : 1.5;
      for (let i = 0; i < preyCount; i++) prey.push(new Prey(preySpeed));

      if (turbidity) {
        let sandSpeed = (level === 4) ? 7.5 : 1.5;
        for (let i = 0; i < preyCount * 5; i++) {
          sandParticles.push(new Sand(sandSpeed));
        }
      }

      copepod = new Copepod();
    }

    class Copepod {
      constructor() {
        this.x = width / 2;
        this.y = height / 2;
        this.speed = 3;
        this.xdir = 0;
        this.ydir = 0;
        this.size = 30;
      }
      move() {
        this.x += this.xdir * this.speed;
        this.y += this.ydir * this.speed;
        this.x = constrain(this.x, 0, width);
        this.y = constrain(this.y, 0, height);
      }
      setDir(x, y) {
        this.xdir = x;
        this.ydir = y;
      }
      show() {
        push();
        translate(this.x, this.y);
        fill(0, 100, 200);
        ellipse(0, 0, this.size, this.size * 0.6);
        stroke(0, 100, 200);
        line(-10, 10, -15, 20);
        line(10, 10, 15, 20);
        pop();
      }
      catches(obj) {
        let d = dist(this.x, this.y, obj.x, obj.y);
        return d < (this.size + obj.size) / 2;
      }
    }

    class Prey {
      constructor(speed = 1.5) {
        this.size = 15;
        this.speed = speed;
        this.reset();
      }
      reset() {
        this.x = random(width);
        this.y = random(height);
        this.setVelocity();
      }
      setVelocity() {
        let angle = random(TWO_PI);
        this.vx = cos(angle) * this.speed;
        this.vy = sin(angle) * this.speed;
      }
      move() {
        this.x += this.vx;
        this.y += this.vy;
        if (this.x < 0 || this.x > width) this.vx *= -1;
        if (this.y < 0 || this.y > height) this.vy *= -1;
      }
      show() {
        push();
        translate(this.x, this.y);
        fill(255, 200, 0);
        ellipse(0, 0, this.size, this.size / 2);
        stroke(255, 200, 0);
        line(this.size / 2, 0, this.size, 0);  // Flagellum
        pop();
      }
    }

    class Sand {
      constructor(speed = 1) {
        this.size = 10;
        this.speed = speed;
        this.reset();
      }
      reset() {
        this.x = random(width);
        this.y = random(height);
        this.vx = random(-this.speed, this.speed);
        this.vy = random(-this.speed, this.speed);
      }
      move() {
        this.x += this.vx;
        this.y += this.vy;
        if (this.x < 0 || this.x > width) this.vx *= -1;
        if (this.y < 0 || this.y > height) this.vy *= -1;
      }
      show() {
        fill(194, 178, 128);
        ellipse(this.x, this.y, this.size);
      }
    }

    class Pellet {
      constructor(x, y, type) {
        this.x = x;
        this.y = y;
        this.type = type;
        this.size = 10;
        this.timestamp = millis();
      }
      show() {
        push();
        translate(this.x, this.y);
        if (this.type === "prey") fill(50);
        else if (this.type === "sand") fill(194, 178, 128);
        else fill(120);
        ellipse(0, 0, this.size * 2, this.size / 2);
        pop();
      }
    }

    // On-screen arrow buttons
    function setupTouchControls() {
      const up = document.getElementById("btn-up");
      const down = document.getElementById("btn-down");
      const left = document.getElementById("btn-left");
      const right = document.getElementById("btn-right");

      function ensureTimerStarted() {
        startTimerIfNeeded();
      }

      function startUp()    { ensureTimerStarted(); copepod.setDir(0, -1); }
      function startDown()  { ensureTimerStarted(); copepod.setDir(0,  1); }
      function startLeft()  { ensureTimerStarted(); copepod.setDir(-1, 0); }
      function startRight() { ensureTimerStarted(); copepod.setDir(1,  0); }
      function stopMove()   { copepod.setDir(0,  0); }

      // Mouse (desktop)
      up.addEventListener("mousedown", (e) => { e.preventDefault(); startUp(); });
      down.addEventListener("mousedown", (e) => { e.preventDefault(); startDown(); });
      left.addEventListener("mousedown", (e) => { e.preventDefault(); startLeft(); });
      right.addEventListener("mousedown", (e) => { e.preventDefault(); startRight(); });
      document.addEventListener("mouseup", (e) => { e.preventDefault(); stopMove(); });

      // Touch (phone)
      up.addEventListener("touchstart", (e) => { e.preventDefault(); startUp(); });
      down.addEventListener("touchstart", (e) => { e.preventDefault(); startDown(); });
      left.addEventListener("touchstart", (e) => { e.preventDefault(); startLeft(); });
      right.addEventListener("touchstart", (e) => { e.preventDefault(); startRight(); });

      ["touchend","touchcancel"].forEach(ev => {
        up.addEventListener(ev, (e) => { e.preventDefault(); stopMove(); });
        down.addEventListener(ev, (e) => { e.preventDefault(); stopMove(); });
        left.addEventListener(ev, (e) => { e.preventDefault(); stopMove(); });
        right.addEventListener(ev, (e) => { e.preventDefault(); stopMove(); });
      });
    }
  </script>
</body>
</html>


